# 环境变量配置指南

## 概述

本项目使用环境变量来安全地存储和管理敏感配置信息。所有敏感信息都存储在 `.env` 文件中，该文件已被添加到 `.gitignore` 中以确保不会被提交到版本控制系统。

## 文件说明

- **`.env`**: 包含真实的环境变量值，用于生产环境
- **`.env.example`**: 模板文件，展示所需的变量但不包含真实值
- **`.gitignore`**: 确保 `.env` 文件不会被提交到版本控制系统

## 环境变量详细说明

### Supabase 配置

#### `SUPABASE_URL`
- **用途**: Supabase 项目的唯一 URL
- **获取方式**: 登录 Supabase 仪表板 → Settings → API → Project URL
- **示例**: `https://your-project-ref.supabase.co`

#### `SUPABASE_ANON_KEY`
- **用途**: Supabase 匿名密钥，用于客户端操作
- **获取方式**: 登录 Supabase 仪表板 → Settings → API → anon public
- **安全性**: 这个密钥在客户端使用是安全的，但不要在服务器端使用

#### `SUPABASE_SERVICE_ROLE_KEY`
- **用途**: Supabase 服务角色密钥，用于服务器端操作
- **获取方式**: 登录 Supabase 仪表板 → Settings → API → service_role
- **安全性**: 🔴 **重要**: 这个密钥具有管理员权限，绝不要在客户端或公开环境中暴露

### 超级管理员凭据

#### `ADMIN_EMAIL`
- **用途**: 系统超级管理员的邮箱地址
- **要求**: 有效的邮箱地址
- **示例**: `admin@yourdomain.com`

#### `ADMIN_PASSWORD`
- **用途**: 超级管理员的初始密码
- **要求**: 强密码（建议包含大小写字母、数字和特殊字符）
- **安全提醒**: 设置后应立即更改为一个安全密码

### 可选安全配置

#### `JWT_SECRET`
- **用途**: 用于签名和验证 JWT 令牌
- **生成方式**: 使用 `openssl rand -hex 32` 生成随机密钥
- **建议**: 使用复杂的随机字符串

#### `ENCRYPTION_SECRET`
- **用途**: 用于敏感数据的加密
- **生成方式**: 使用 `openssl rand -hex 32` 生成随机密钥
- **建议**: 使用复杂的随机字符串

#### `NODE_ENV`
- **用途**: 设置运行环境
- **选项**: `development`, `production`, `test`
- **影响**: 开发模式会启用详细日志

#### `DB_TIMEOUT`
- **用途**: 数据库连接超时时间（秒）
- **默认值**: `30`

#### `API_TIMEOUT`
- **用途**: API 请求超时时间（毫秒）
- **默认值**: `10000`

## 设置步骤

### 1. 复制模板文件
```bash
cp .env.example .env
```

### 2. 获取 Supabase 配置
1. 登录 [Supabase 仪表板](https://supabase.com/dashboard)
2. 选择您的项目
3. 进入 Settings → API
4. 复制以下信息：
   - Project URL
   - anon public key
   - service_role key

### 3. 设置管理员凭据
1. 选择一个有效的邮箱地址作为管理员邮箱
2. 设置一个安全的密码

### 4. 生成安全密钥（可选但推荐）
```bash
# 生成 JWT 密钥
openssl rand -hex 32

# 生成加密密钥
openssl rand -hex 32
```

### 5. 编辑 .env 文件
```bash
nano .env
```
将模板值替换为您的真实配置值。

## 安全最佳实践

### 1. 文件权限
确保 `.env` 文件权限设置正确：
```bash
chmod 600 .env
```

### 2. 密码强度
- 管理员密码应包含至少 12 个字符
- 混合使用大小写字母、数字和特殊字符
- 避免使用字典单词或个人信息

### 3. 密钥管理
- 定期轮换敏感密钥
- 不要在代码中硬编码敏感信息
- 生产环境使用专门的密钥管理服务

### 4. 环境分离
- 开发、测试和生产环境使用不同的配置
- 生产环境使用更强的安全措施

### 5. 备份策略
- 定期备份配置文件（注意安全存储）
- 确保在系统故障时能够恢复配置

## 环境变量使用示例

### 在 JavaScript/TypeScript 中使用
```javascript
import dotenv from 'dotenv';

// 加载环境变量
dotenv.config();

// 使用环境变量
const supabaseUrl = process.env.SUPABASE_URL;
const supabaseAnonKey = process.env.SUPABASE_ANON_KEY;
const adminEmail = process.env.ADMIN_EMAIL;

// 验证必需的环境变量
if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing required Supabase configuration');
}
```

### 在 Node.js 中使用
```javascript
require('dotenv').config();

const config = {
  supabase: {
    url: process.env.SUPABASE_URL,
    anonKey: process.env.SUPABASE_ANON_KEY,
    serviceRoleKey: process.env.SUPABASE_SERVICE_ROLE_KEY
  },
  admin: {
    email: process.env.ADMIN_EMAIL,
    password: process.env.ADMIN_PASSWORD
  }
};

module.exports = config;
```

## 故障排除

### 常见问题

1. **环境变量未加载**
   - 确保 `.env` 文件位于项目根目录
   - 检查文件权限
   - 确认使用了 `dotenv` 或类似库

2. **Supabase 连接失败**
   - 验证 URL 格式是否正确
   - 确认密钥是否有效且未过期
   - 检查项目状态是否正常

3. **权限错误**
   - 确认服务角色密钥是否正确
   - 检查 RLS 策略配置
   - 验证数据库权限设置

### 日志调试
设置 `NODE_ENV=development` 来启用详细日志：
```bash
NODE_ENV=development npm start
```

## 注意事项

1. **绝不提交 .env 文件到版本控制**
2. **生产环境应使用专门的配置管理系统**
3. **定期审查和更新安全配置**
4. **监控异常访问和配置变更**

## 联系支持

如果遇到配置问题，请检查：
1. 本文档的故障排除部分
2. 项目日志文件
3. Supabase 项目状态

---

**安全提醒**: 请妥善保管所有敏感信息，遵循安全最佳实践。