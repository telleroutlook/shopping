# 环境变量配置指南

本指南说明 React 客户端、Supabase Edge Functions 以及测试脚本使用的全部环境变量，并给出推荐的放置位置与安全策略。

## 文件与放置位置
| 文件 | 作用 | 备注 |
| --- | --- | --- |
| `jd-shop/.env` | 提供给 Vite/React 客户端读取的变量，必须使用 `VITE_` 前缀。 | 仅包含公开可暴露的值，例如 Supabase public URL/Anon Key。 |
| `.env.example` | 仓库模板（位于根目录）。从这里复制内容到 `jd-shop/.env`。 | 不含真实值，可安全提交。 |
| `supabase/.env` 或 CLI profile | Supabase Edge Function、迁移、脚本运行时需要的安全变量。 | 不要提交，通常由部署平台或 Supabase CLI 注入。 |

> `.env` 已加入 `.gitignore`，请不要手动移除。

## 客户端变量（Vite）
这些变量在 `jd-shop/.env` 中配置，Vite 会通过 `import.meta.env` 注入到浏览器端代码。

### `VITE_SUPABASE_URL`
- **用途**：指定 Supabase 项目的 REST / Edge Function URL。
- **来源**：Supabase 控制台 → Settings → API → Project URL。
- **示例**：`https://your-project-ref.supabase.co`。

### `VITE_SUPABASE_ANON_KEY`
- **用途**：Supabase 匿名公钥，供浏览器端初始化 `createClient`。
- **来源**：Supabase 控制台 → Settings → API → `anon public`。
- **安全性**：可以出现在客户端，但不要在未经授权的环境中滥用。

> **提示**：前端只需要上述两个变量。其余敏感凭据不要放入 `VITE_` 变量，否则会被打包到浏览器。

## 服务器/Edge Function 变量
这些变量通过 Supabase CLI、部署平台（如 Supabase dashboard、Deno Deploy）或本地 `supabase/.env` 输入，用于 Deno Edge Functions 或 SQL 迁移脚本。

| 变量 | 用途 | 说明 |
| --- | --- | --- |
| `SUPABASE_URL` | Server 侧访问 REST/Auth 时使用的 base URL | 与 `VITE_SUPABASE_URL` 相同，但不需要 `VITE_` 前缀。 |
| `SUPABASE_ANON_KEY` | Edge Function 读取公开数据时可使用 | 可选。 |
| `SUPABASE_SERVICE_ROLE_KEY` | 调用 `auth.admin`、跨租户查询、写入受保护表 | **高权限密钥**，绝不放在客户端或提交到仓库。 |
| `STRIPE_SECRET_KEY` | `create-payment-intent` Edge Function 调用 Stripe API | 仅在启用 Stripe 支付流时必填。 |
| 其他业务变量 | 例如 Webhook Secret、第三方 API Key | 按需添加，保持命名清晰。 |

## 配置步骤
1. **复制模板**
   ```bash
   cd jd-shop
   cp ../.env.example .env
   ```
2. **填写客户端变量**
   ```env
   VITE_SUPABASE_URL=https://your-project-ref.supabase.co
   VITE_SUPABASE_ANON_KEY=your-public-anon-key
   ```
3. **配置 Edge Function/CLI**
   - 在本地：`supabase/config.toml` 或 `supabase/.env` 中加入 `SUPABASE_URL`、`SUPABASE_SERVICE_ROLE_KEY`、`STRIPE_SECRET_KEY` 等。
   - 在线部署：在 Supabase Dashboard → Project Settings → Functions → Environment Variables 中添加同名变量。
4. **验证**
   - 运行 `pnpm dev`，确保没有 `VITE_*` 缺失警告。
   - 使用 `supabase functions serve --env-file supabase/.env` 本地调试 Edge Function，确认可以访问数据库。

## 在代码中使用变量
### 浏览器/React 端
```ts
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase client configuration')
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

### Edge Function / Node 脚本（Deno API）
```ts
const supabaseUrl = Deno.env.get('SUPABASE_URL')
const serviceRoleKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')

if (!supabaseUrl || !serviceRoleKey) {
  throw new Error('Supabase service credentials are missing')
}
```

## 安全建议
1. **最小曝光**：客户端 `.env` 仅存放 `VITE_*` 变量；所有高权限密钥使用服务器端配置。
2. **访问控制**：给 Supabase Service Role 密钥设置轮换计划，并存放在秘密管理器（如 1Password, Vault, Supabase Secrets）。
3. **权限验证**：确保 Edge Function 在访问数据库前再次检查 JWT/角色，而不是依赖客户端输入。
4. **多环境隔离**：开发/测试/生产分别维护 `.env` 文件，避免复用同一套凭据。
5. **版本控制**：不要通过 Git、Issue 或 PR 评论分享真实密钥。如需协作，请使用加密渠道。

## 故障排查
| 问题 | 排查思路 |
| --- | --- |
| `VITE_SUPABASE_URL is not defined` | `.env` 是否位于 `jd-shop/`，并以 `VITE_` 开头；修改后需重启 `pnpm dev`。 |
| Edge Function 返回 401/403 | 检查 `Authorization` 请求头、RLS 策略以及 `SUPABASE_SERVICE_ROLE_KEY` 是否配置。 |
| Stripe API 报错 `No such key` | 确认部署环境设置了 `STRIPE_SECRET_KEY`，同时金额/币种传参正确。 |
| Supabase CLI 无法访问项目 | `supabase/config.toml` 中是否指向正确项目 id，并提供了 URL/Key。 |

按照以上步骤即可让 React 客户端、Edge Functions 与脚本使用一致、可维护的环境变量配置。EOF
